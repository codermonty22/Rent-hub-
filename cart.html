<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Your shopping cart - RentHuB">
    <meta name="keywords" content="cart, rental, products, RentHuB">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>Shopping Cart - RentHuB</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <nav class="container">
            <div class="logo" onclick="navigateHome()">RentHuB</div>
            <div class="nav-links">
                <a href="#" data-page="home" onclick="navigateHome(event)">Home</a>
                <a href="#" data-page="products" onclick="navigateProducts(event)">Products</a>
                <a href="#" data-page="categories" onclick="navigateCategories(event)">Categories</a>
                <a href="#" data-page="about" onclick="navigateAbout(event)">About</a>
                <div class="cart-container">
                    <button class="cart-icon active" onclick="toggleCart()" aria-label="Shopping cart">
                        <i class="fas fa-shopping-cart"></i>
                    </button>
                    <span class="cart-count" id="cartCount">0</span>
                </div>
            </div>
        </nav>
    </header>

    <main class="container">
        <div class="cart-header">
            <h1><i class="fas fa-shopping-cart"></i> Shopping Cart</h1>
            <div class="cart-actions">
                <button class="btn btn-secondary" onclick="clearCart()">
                    <i class="fas fa-trash"></i> Clear Cart
                </button>
            </div>
        </div>

        <div class="cart-content" id="cartContent">
            <!-- Cart items will be loaded here -->
        </div>

        <div class="cart-summary" id="cartSummary" style="display: none;">
            <div class="summary-card">
                <h3>Order Summary</h3>
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="subtotal">₹0</span>
                </div>
                <div class="summary-row">
                    <span>Security Deposit:</span>
                    <span id="deposit">₹0</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span id="total">₹0</span>
                </div>
                <button class="btn btn-primary checkout-btn" onclick="proceedToCheckout()">
                    <i class="fas fa-credit-card"></i> Proceed to Checkout
                </button>
                <div class="checkout-notice">
                    <i class="fas fa-info-circle"></i>
                    You will be redirected to complete your rental agreement and payment.
                </div>
            </div>
        </div>
    </main>

    <!-- Toast notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage"></span>
    </div>

    <!-- Modal for updating cart item -->
    <div class="modal" id="updateCartModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeUpdateModal()">&times;</button>
            <h3>Update Cart Item</h3>
            <form class="update-cart-form" onsubmit="updateCartItem(event)">
                <input type="hidden" id="updateProductId">
                <input type="hidden" id="updateDuration">
                <input type="hidden" id="updateUnit">

                <div class="form-group">
                    <label class="form-label" for="updateQuantity">Quantity:</label>
                    <input type="number" id="updateQuantity" class="form-input" min="1" value="1" required>
                </div>

                <button type="submit" class="btn btn-primary">Update Item</button>
            </form>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Cart-specific functions
        let currentCart = [];

        async function loadCartPage() {
            const cartContent = document.getElementById('cartContent');
            const cartSummary = document.getElementById('cartSummary');

            cartContent.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading cart...</div>';

            try {
                let products = [];

                if (isLoggedIn()) {
                    const response = await apiCall('/cart');
                    products = response.cart || [];
                } else {
                    // For guest users, get from localStorage and fetch product details
                    const cartItems = JSON.parse(localStorage.getItem('guestCart') || '[]');
                    if (cartItems.length > 0) {
                        const response = await apiCall('/products');
                        const allProducts = response.products || [];
                        products = cartItems.map(cartItem => {
                            const product = allProducts.find(p => p._id === cartItem.product_id);
                            if (product) {
                                return {
                                    ...product,
                                    cart_quantity: cartItem.quantity,
                                    cart_duration: cartItem.duration,
                                    cart_unit: cartItem.unit
                                };
                            }
                            return null;
                        }).filter(p => p !== null);
                    }
                }

                currentCart = products;
                updateCartCount(products.length);

                cartContent.innerHTML = '';

                if (products.length === 0) {
                    cartContent.innerHTML = `
                        <div class="empty-cart">
                            <i class="fas fa-shopping-cart"></i>
                            <h3>Your cart is empty</h3>
                            <p>Start browsing and add items to rent!</p>
                            <a href="products.html" class="btn btn-primary">Browse Products</a>
                        </div>
                    `;
                    cartSummary.style.display = 'none';
                    return;
                }

                // Render cart items
                products.forEach(product => {
                    const cartItem = document.createElement('div');
                    cartItem.className = 'cart-item';
                    cartItem.setAttribute('data-product-id', product._id);

                    const imageUrl = product.images?.[0]
                        ? (product.images[0].startsWith('http') ? product.images[0] : IMAGE_BASE_URL + '/' + product.images[0].replace(/^\/+/, ''))
                        : "https://images.unsplash.com/photo-1555041469-a586c61ea9bc?w=400&h=300&fit=crop";

                    cartItem.innerHTML = `
                        <div class="cart-item-image">
                            <a href="product.html?id=${product._id}">
                                <img src="${imageUrl}" alt="${product.title}">
                            </a>
                        </div>
                        <div class="cart-item-details">
                            <h3><a href="product.html?id=${product._id}">${product.title}</a></h3>
                            <div class="cart-item-info">
                                <span class="cart-item-price">₹${product.price} /${product.rental_type}</span>
                                <span class="cart-item-duration">Duration: ${product.cart_duration} ${product.cart_unit}</span>
                                <span class="cart-item-quantity">Quantity: ${product.cart_quantity}</span>
                            </div>
                            <div class="cart-item-location">
                                <i class="fas fa-map-marker-alt"></i> ${product.location || 'Location not specified'}
                            </div>
                        </div>
                        <div class="cart-item-actions">
                            <button class="btn btn-small" onclick="openUpdateModal('${product._id}', '${product.cart_duration}', '${product.cart_unit}', ${product.cart_quantity})">
                                <i class="fas fa-edit"></i> Update
                            </button>
                            <button class="btn btn-small btn-danger" onclick="removeFromCart('${product._id}', '${product.cart_duration}', '${product.cart_unit}')">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    `;

                    cartContent.appendChild(cartItem);
                });

                // Show summary
                cartSummary.style.display = 'block';
                updateCartSummary(products);

            } catch (error) {
                console.error('Error loading cart:', error);
                cartContent.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Failed to load cart</h3>
                        <p>Please try again later.</p>
                    </div>
                `;
            }
        }

        function updateCartSummary(products) {
            let subtotal = 0;
            let deposit = 0;

            products.forEach(product => {
                const price = parseFloat(product.price) || 0;
                const quantity = product.cart_quantity || 1;
                const duration = parseInt(product.cart_duration) || 1;

                // Calculate price based on duration
                let itemTotal = price * quantity;
                if (product.cart_unit === 'week') {
                    itemTotal *= 7;
                } else if (product.cart_unit === 'month') {
                    itemTotal *= 30;
                }

                subtotal += itemTotal;
                deposit += itemTotal * 0.1; // 10% security deposit
            });

            const total = subtotal + deposit;

            document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
            document.getElementById('deposit').textContent = `₹${deposit.toFixed(2)}`;
            document.getElementById('total').textContent = `₹${total.toFixed(2)}`;
        }

        function updateCartCount(count) {
            const cartCountEl = document.getElementById('cartCount');
            if (cartCountEl) {
                cartCountEl.textContent = count;
            }
        }

        async function removeFromCart(productId, duration, unit) {
            if (!confirm('Are you sure you want to remove this item from your cart?')) {
                return;
            }

            try {
                if (isLoggedIn()) {
                    await apiCall('/cart/remove', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            product_id: productId,
                            duration: duration,
                            unit: unit
                        })
                    });
                } else {
                    // For guest users, update localStorage
                    let cart = JSON.parse(localStorage.getItem('guestCart') || '[]');
                    cart = cart.filter(item => !(item.product_id === productId && item.duration === duration && item.unit === unit));
                    localStorage.setItem('guestCart', JSON.stringify(cart));
                }

                showToast('Item removed from cart!', 'success');
                loadCartPage();
            } catch (error) {
                console.error('Error removing from cart:', error);
                showToast('Failed to remove item from cart', 'error');
            }
        }

        async function clearCart() {
            if (!confirm('Are you sure you want to clear your entire cart?')) {
                return;
            }

            try {
                if (isLoggedIn()) {
                    await apiCall('/cart/clear', { method: 'POST' });
                } else {
                    localStorage.removeItem('guestCart');
                }

                showToast('Cart cleared!', 'success');
                loadCartPage();
            } catch (error) {
                console.error('Error clearing cart:', error);
                showToast('Failed to clear cart', 'error');
            }
        }

        function openUpdateModal(productId, duration, unit, quantity) {
            document.getElementById('updateProductId').value = productId;
            document.getElementById('updateDuration').value = duration;
            document.getElementById('updateUnit').value = unit;
            document.getElementById('updateQuantity').value = quantity;
            document.getElementById('updateCartModal').style.display = 'flex';
        }

        function closeUpdateModal() {
            document.getElementById('updateCartModal').style.display = 'none';
        }

        async function updateCartItem(event) {
            event.preventDefault();

            const productId = document.getElementById('updateProductId').value;
            const duration = document.getElementById('updateDuration').value;
            const unit = document.getElementById('updateUnit').value;
            const quantity = parseInt(document.getElementById('updateQuantity').value);

            try {
                if (isLoggedIn()) {
                    await apiCall('/cart/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            product_id: productId,
                            quantity: quantity,
                            duration: duration,
                            unit: unit
                        })
                    });
                } else {
                    // For guest users, update localStorage
                    let cart = JSON.parse(localStorage.getItem('guestCart') || '[]');
                    const itemIndex = cart.findIndex(item =>
                        item.product_id === productId &&
                        item.duration === duration &&
                        item.unit === unit
                    );
                    if (itemIndex > -1) {
                        cart[itemIndex].quantity = quantity;
                        localStorage.setItem('guestCart', JSON.stringify(cart));
                    }
                }

                showToast('Cart item updated!', 'success');
                closeUpdateModal();
                loadCartPage();
            } catch (error) {
                console.error('Error updating cart item:', error);
                showToast('Failed to update cart item', 'error');
            }
        }

        function proceedToCheckout() {
            if (!isLoggedIn()) {
                showToast('Please log in to proceed with checkout', 'error');
                window.location.href = 'login.html';
                return;
            }

            if (currentCart.length === 0) {
                showToast('Your cart is empty', 'error');
                return;
            }

            // For now, show a message that checkout is not implemented yet
            showToast('Checkout functionality will be available soon!', 'info');
        }

        // Initialize cart page
        document.addEventListener('DOMContentLoaded', () => {
            updateProfileDropdown();
            loadCartPage();
        });
    </script>
</body>
</html>
